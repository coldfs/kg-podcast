<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!--[if IE 6]>
<link href="/css/ie6.css" rel="stylesheet" type="text/css" />
<![endif]-->

<link href="js/prettify-jPlayer.css" rel="stylesheet" type="text/css" />
<link href="js/jplayer.blue.monday.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="js/jquery.jplayer.min.js"></script>
<script type="text/javascript" src="js/jplayer.playlist.min.js"></script>
<!-- <script type="text/javascript" src="data.js"></script> -->
<script type="text/javascript">
function initPlayer(playlist, i) {
	$('#active').empty();
	$('#active').html($('#template').html());
	// Тепреь то я знаю что можно просто сделать setPlaylist. Ну да пофигу
	 a = new jPlayerPlaylist({
		jPlayer: "#active .kg-js-player",
		cssSelectorAncestor: "#active .kg-js-audio"
	}, playlist, {
		playlistOptions: {
			autoPlay: false,
		},
		preload: 'none',
		swfPath: "js",
		supplied: "mp3",
		wmode: "window",
		smoothPlayBar: true,
		keyEnabled: true
	});

	setTimeout(function() {
		a.play(i);
	}, 1000);
}
function showResults(results)
{
	el = $('#results');
	el.empty();
	if (results.length == 0) {
		el.append('<h2>Ничего не найдено</h2>');
		return;
	}
	$.each(results, function(i, podcast) {
		el.append('<h2>' + podcast.title + '</h2>');
		$.each(podcast.content, function(index, part) {
			var e = $('<h4>' + part.original + '</h4>');
			e.on('click', function() {
				draw(podcast.id, part.index);
			})
			el.append(e);
		});
	})
}
function draw(podcastId, partId)
{
	var playlist = [];
	$.each(data, function(index, element) {
		if (element.id == podcastId) {
			$.each(element.content, function(i, part) {
				playlist.push({
					title: part.original,
					mp3: 'audio/chunked/' + podcastId + '_' + i + '.mp3'
				})
			});
		}
	});

	initPlayer(playlist, partId);

}

var data = [];
$(document).ready(function(){
	// disable while localhost
	$.get('data.json', function(response) {
		data = response;
	});
	// немного говнокода во славу сатане
	$('#search').on('click', function() {
		var query = $('[name="query"]').val();
		var sr = [];
		$.each(data, function(index, element) {
			//
			var result = {id: element.id, title: element.title, 'content': []};
			var reg = new RegExp(query, 'i')
			$.each(element.content, function(ind, part) {
				if (reg.test(part.title)) {
					part.index = ind;
					result.content.push(part);
				}
			})
			if (result.content.length > 0) {
				sr.push(result);
			}
		});
		showResults(sr);
		return false;
	});
});

function test() {

	initPlayer([
		{
			title: 'Новости',
			mp3: 'audio/chunked/2_0.mp3'
		},
		{
			title: 'Бокс-офис',
			mp3: 'audio/chunked/2_1.mp3'
		},
	]);
}

</script>

</head>
<body>
	<h1>КГ-Подкаст поиск</h1>
	<div id="active" style="width:420px;float:right;"></div>
	<div style="margin-right:420px">
		<input type="text" name="query"/>
		<input type="button" value="Искать" id="search"/>
		<br/>
		<div id="results"></div>
	</div>
	<div id="template" style="display:none">
		<div class="jp-jplayer kg-js-player"></div>
		<div id="jp_container_1" class="jp-audio kg-js-audio" >
			<div class="jp-type-playlist">
				<div class="jp-gui jp-interface">
					<ul class="jp-controls">
						<li><a href="javascript:;" class="jp-previous" tabindex="1">previous</a></li>
						<li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
						<li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
						<li><a href="javascript:;" class="jp-next" tabindex="1">next</a></li>
						<li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
						<li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
						<li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
						<li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
					</ul>
					<div class="jp-progress">
						<div class="jp-seek-bar">
							<div class="jp-play-bar"></div>

						</div>
					</div>
					<div class="jp-volume-bar">
						<div class="jp-volume-bar-value"></div>
					</div>
					<div class="jp-current-time"></div>
					<div class="jp-duration"></div>
					<ul class="jp-toggles">
						<!-- <li><a href="javascript:;" class="jp-shuffle" tabindex="1" title="shuffle">shuffle</a></li> -->
						<!-- <li><a href="javascript:;" class="jp-shuffle-off" tabindex="1" title="shuffle off">shuffle off</a></li> -->
						<li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
						<li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
					</ul>
				</div>
				<div class="jp-playlist">
					<ul>
						<li></li>
					</ul>
				</div>
				<div class="jp-no-solution">
					<span>Update Required</span>
					To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
				</div>
			</div>
		</div>
	</div>
</body>
</html>